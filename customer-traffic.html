<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>客数</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

<!-- Step 1) Load D3.js -->
<script src="https://d3js.org/d3.v5.min.js"></script>

<!-- Step 2) Load billboard.js with style -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.0.3/billboard.min.js"></script>

<!-- Load with base style -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.0.3/billboard.min.css">

<!-- Or load different theme style -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.0.3/theme/insight.min.css">
<style>
</style>
</head>
<body>
  <div class="container-fluid">
    <h1>客数の傾向</h1>
    <div class="alert alert-success" role="alert">
      <div id="trend"></div>
    </div>
    <div id="chart"></div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
<script>
const time = (new Date()).getTime();
const arrowUpRight = `
<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-up-right" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 2.5a.5.5 0 0 0-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0v-6z"/>
</svg>`;

const arrowDownRight = `
<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-down-right" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 13.5a.5.5 0 0 1-.5.5h-6a.5.5 0 0 1 0-1h4.793L2.146 2.854a.5.5 0 1 1 .708-.708L13 12.293V7.5a.5.5 0 0 1 1 0v6z"/>
</svg>`;

Papa.parse(`./customer_traffic.csv?${time}`, {
  download: true,
  complete: function(results) {
    console.log(results.data)
    const trend = results.data.filter((_,i) => i > 0)
    .reduce((ax, x) => {
      return ax.map((a, j) => {
        const n = Number(x[j + 1])
        return a + (Number.isNaN(n) ? 0 : n)
      });
    }, [0,0])
    console.log(trend)
    const rate = ((trend[0]/trend[1] - 1) * 100).toFixed(2)
    const color = rate < 0 ? 'red' : 'blue'
    const direction = rate < 0 ? arrowDownRight : arrowUpRight;
    document.getElementById('trend').innerHTML = `${trend[0].toLocaleString()} <span class="badge badge-light" style="color:${color};">${direction}${Math.abs(rate)}%</span>`;
  }
});

var chart = bb.generate({
    bindto: "#chart",
    title: {
      text: "レジ通過客数"
    },
    data: {
        x: "x",
        url: `./customer_traffic.csv?${time}`,
        colors: {
          "現在の期間": "rgb(0,199,60)",
          "前の期間": "#666666",
        },
        regions: {
          "前の期間": [
            {
              start: 0,
            },
          ]
        }
    },
    axis: {
      x: {
        type: "timeseries",
        tick: {
          rotate: 45,
          format: "%y-%m-%d"
        }
      }
    },
});
</script>
</body>
</html>
